// =========================================
// 1. ç ”ç©¶åŒºä¸åŸºç¡€è®¾ç½® (Spatial & Basic Setup)
// =========================================

// 1.1 æ ¸å¿ƒçŸ¢é‡
var qingdao_full = ee.FeatureCollection("users/Qiyuan_Zheng/myshapes");
var centerPoint = ee.Geometry.Point([120.0, 35.85]); 

// 1.2 ç§‘å­¦ç›‘æµ‹åŒºæ„å»º (Study Area)
var huangdao_fc = qingdao_full.filterBounds(centerPoint);
var geometry_huangdao = huangdao_fc.geometry().simplify(100); 

// é™†åœ°æ©è†œ (ç”¨äºæŒ–é™¤)
var shandong_geo = ee.FeatureCollection("FAO/GAUL/2015/level1")
    .filter(ee.Filter.eq('ADM1_NAME', 'Shandong'))
    .geometry().simplify(300); 
var qingdao_geo = qingdao_full.geometry().simplify(300);
var land_mask = shandong_geo.union(qingdao_geo).simplify(300);

// è±¡é™æ©è†œ (åªä¿ç•™ä¸œä¾§)
var east_side_mask = ee.Geometry.Rectangle([120.0, 35.0, 122.0, 36.5]); 

// ç”Ÿæˆæœ€ç»ˆç›‘æµ‹åŒº
var raw_buffer = geometry_huangdao.buffer(22224, 100); 
var study_area = raw_buffer
    .intersection(east_side_mask, 100)
    .difference(land_mask, 100); 

// 1.3 åœ°å›¾åˆå§‹åŒ–
Map.centerObject(centerPoint, 10);
Map.setOptions('HYBRID'); 
Map.style().set('cursor', 'crosshair');

// =========================================
// 2. æ ¸å¿ƒç®—æ³• (Core Algorithms)
// =========================================

var NDVI_THRESHOLD = 0.10; 
var water_mask = ee.Image("JRC/GSW1_4/GlobalSurfaceWater")
    .select('occurrence').gt(80).unmask(0);

// å…¨çƒå½±åƒè·å– (ç”¨äºå…¨å±åº•å›¾)
function getGlobalS2(year) {
  var start = year + '-06-10'; 
  var end = year + '-07-25';
  return ee.ImageCollection("COPERNICUS/S2_SR_HARMONIZED")
    .filterDate(start, end)
    .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 20));
}

// ç›‘æµ‹åŒºå½±åƒè·å– (ç”¨äºåˆ†æ)
function getAnalysisS2(year) {
  var start = year + '-06-10'; 
  var end = year + '-07-25';
  return ee.ImageCollection("COPERNICUS/S2_SR_HARMONIZED")
    .filterBounds(study_area)
    .filterDate(start, end)
    .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 20));
}

// æµ’è‹”æå– (ç§‘å­¦å»æ³¥æ²™ç‰ˆ)
function extractAlgae(img) {
    var ndvi = img.normalizedDifference(['B8', 'B4']).rename('NDVI');
    var is_algae_spectrum = img.select('B4').lt(1200); // æ³¥æ²™è¿‡æ»¤
    return img.addBands(ndvi)
              .updateMask(water_mask)     
              .updateMask(is_algae_spectrum)
              .clip(study_area)
              .copyProperties(img, ['system:time_start']); 
}

// =========================================
// 3. å…¨å±€çŠ¶æ€ç®¡ç† (Global State)
// =========================================
var appState = {
  currentYear: '2023',
  processedCol: null, 
  binaryLayer: null,  
  heatmapLayer: null, 
  currentLayer: null, 
  statsArea: 0
};

// =========================================
// 4. äº¤äº’å¼ UI è®¾è®¡ (Advanced UI)
// =========================================

ui.root.clear(); 

var panel = ui.Panel({
  style: {
    width: '400px', 
    padding: '15px', 
    backgroundColor: 'rgba(255, 255, 255, 0.95)',
    border: '1px solid #dcdcdc', 
    position: 'top-right'
  }
});

var map = ui.Map();
map.centerObject(centerPoint, 10);
Map.setOptions('HYBRID');
ui.root.add(panel);
ui.root.add(map);

// --- 4.1 æ ‡é¢˜åŒº ---
panel.add(ui.Label({
  value: 'ğŸŒŠ Enteromorpha Interactive System',
  style: {fontSize: '22px', fontWeight: '900', color: '#1f618d', margin: '0 0 5px 0'}
}));
panel.add(ui.Label({
  value: 'Qingdao West Coast New Area',
  style: {fontSize: '12px', color: '#555', margin: '0 0 15px 0'}
}));

// --- 4.2 æ§åˆ¶åŒº (å¹´ä»½ & æ ·å¼) ---
panel.add(ui.Label('1. Control Panel', {fontWeight: 'bold', fontSize: '14px', margin: '10px 0'}));

// A. å¹´ä»½é€‰æ‹©
var selectYear = ui.Select({
  items: ['2023', '2022', '2021', '2020', '2019'],
  placeholder: 'Select Year...', 
  onChange: function(year) {
    runAnalysis(year); 
  },
  style: {width: '100%', margin: '0 0 10px 0'}
});
panel.add(ui.Label('Monitoring Year:', {fontSize: '11px', color: '#777'}));
panel.add(selectYear);

// B. æ˜¾ç¤ºæ¨¡å¼
var layerMode = ui.Select({
  items: [
    {label: 'ğŸ›‘ Classification (Binary)', value: 'binary'},
    {label: 'ğŸŒˆ Intensity Heatmap (NDVI)', value: 'heatmap'}
  ],
  value: 'binary',
  onChange: updateVisualization, 
  style: {width: '100%', margin: '0 0 10px 0'}
});
panel.add(ui.Label('Display Mode:', {fontSize: '11px', color: '#777'}));
panel.add(layerMode);

// C. é¢œè‰²ä¸»é¢˜ 
var colorTheme = ui.Select({
  items: [
    {label: 'ğŸš¨ Standard Red', value: 'FF0000'},
    {label: 'ğŸ‘½ Cyber Green', value: '00FF00'},
    {label: 'ğŸŠ Warning Orange', value: 'FFA500'},
    {label: 'ğŸ”® Deep Purple', value: '800080'},
    {label: 'ğŸ² Random Color', value: 'random'}
  ],
  value: 'FF0000',
  onChange: updateVisualization,
  style: {width: '100%', margin: '0 0 10px 0'}
});
panel.add(ui.Label('Color Theme:', {fontSize: '11px', color: '#777'}));
panel.add(colorTheme);

// D. é€æ˜åº¦æ»‘å—
var opacitySlider = ui.Slider({
  min: 0, max: 1, value: 0.9, step: 0.1,
  style: {width: '95%'},
  onChange: function(value) {
    var layers = map.layers();
    if (layers.length() > 2) { 
       layers.get(2).setOpacity(value);
    }
  }
});
panel.add(ui.Label('Algae Layer Opacity:', {fontSize: '11px', color: '#777'}));
panel.add(opacitySlider);

// --- 4.3 ç»“æœå±•ç¤ºåŒº ---
var resultPanel = ui.Panel();
panel.add(resultPanel);

// --- 4.4 ç‚¹ä½ä¾¦æµ‹åŒº ---
panel.add(ui.Label('2. Point Inspector', {fontWeight: 'bold', fontSize: '14px', margin: '15px 0 5px 0'}));
var inspectorPanel = ui.Panel({
  style: {border: '1px dashed #aaa', padding: '8px', backgroundColor: '#f9f9f9'}
});
inspectorPanel.add(ui.Label('Click on the map to inspect NDVI trend.', {fontSize: '11px', color: 'gray'}));
panel.add(inspectorPanel);

// --- 4.5 æ•°æ®ä¸‹è½½åŒº ---
panel.add(ui.Label('3. Data Export', {fontWeight: 'bold', fontSize: '14px', margin: '15px 0 5px 0'}));
var downloadPanel = ui.Panel({layout: ui.Panel.Layout.flow('horizontal')});
panel.add(downloadPanel);

// =========================================
// 5. åˆ†ææ‰§è¡Œé€»è¾‘
// =========================================

function runAnalysis(year) {
  appState.currentYear = year;
  
  // é‡ç½®çŠ¶æ€
  map.layers().reset();
  resultPanel.clear();
  inspectorPanel.clear();
  downloadPanel.clear();
  inspectorPanel.add(ui.Label('Click map to inspect point in ' + year + '...', {fontSize: '11px', color: 'gray'}));
  resultPanel.add(ui.Label('Processing ' + year + '...', {color: 'gray'}));

  var s2_global = getGlobalS2(year);
  var s2_analysis = getAnalysisS2(year);

  s2_analysis.size().evaluate(function(count) {
    if (count === 0) {
      resultPanel.clear();
      resultPanel.add(ui.Label('No images found for ' + year, {color: 'red'}));
      return;
    }

    // 1. å…¨å±åº•å›¾ (ä¸­å€¼åˆæˆ)
    var global_mosaic = s2_global.median(); 
    var rgbVis = {bands: ['B4', 'B3', 'B2'], min: 0, max: 3000, gamma: 1.1};
    map.addLayer(global_mosaic, rgbVis, 'True Color (' + year + ')', true);

    // 2. è¾¹ç•Œè£…é¥°
    var empty = ee.Image().byte();
    var outline = empty.paint({featureCollection: huangdao_fc, color: 1, width: 2});
    map.addLayer(outline, {palette: ['FFD700']}, 'Huangdao', true, 1.0);

    // 3. æµ’è‹”è®¡ç®—
    var s2_processed = s2_analysis.map(extractAlgae);
    appState.processedCol = s2_processed; 

    var max_mosaic = s2_processed.qualityMosaic('NDVI');
    
    // ã€å…³é”®ã€‘ï¼šå‡†å¤‡ä¸¤å¥—æ•°æ®ä¾›åˆ‡æ¢
    // A: äºŒå€¼æ•°æ® (ç”¨äº Classification æ¨¡å¼)
    appState.binaryLayer = max_mosaic.select('NDVI').gt(NDVI_THRESHOLD).selfMask();
    // B: çƒ­åŠ›æ•°æ® (ç”¨äº Heatmap æ¨¡å¼)
    appState.heatmapLayer = max_mosaic.select('NDVI').updateMask(appState.binaryLayer);
    
    // 4. è°ƒç”¨å¯è§†åŒ–æ›´æ–°å‡½æ•° (ç¬é—´æ¸²æŸ“)
    updateVisualization();

    // 5. ç»Ÿè®¡é¢ç§¯
    var area_img = appState.binaryLayer.multiply(ee.Image.pixelArea());
    var stats = area_img.reduceRegion({
      reducer: ee.Reducer.sum(),
      geometry: study_area,
      scale: 100, maxPixels: 1e13
    });
    
    // 6. åŒºåŸŸè¶‹åŠ¿å›¾
    var chart = ui.Chart.image.series({
      imageCollection: s2_processed.select('NDVI'), 
      region: study_area,
      reducer: ee.Reducer.max(),
      scale: 500, xProperty: 'system:time_start'
    }).setOptions({
      title: 'Regional Bloom Intensity',
      vAxis: {title: 'Max NDVI'},
      hAxis: {title: 'Date', format: 'MM-dd'},
      colors: ['#27ae60'], height: 180, legend: {position: 'none'}
    });

    stats.evaluate(function(val) {
      resultPanel.clear();
      var area_km2 = (val['NDVI'] || 0) / 1e6;
      appState.statsArea = area_km2;
      
     
      resultPanel.add(ui.Label('Total Area: ' + area_km2.toFixed(2) + ' kmÂ²', {
        color: '#d32f2f', fontWeight: '900', fontSize: '28px', margin: '5px 0'
      }));
      resultPanel.add(chart);
      
    
      updateDownloadButtons();
    });
  });
}


function updateVisualization() {
 
  if (!appState.binaryLayer) return;
  var layers = map.layers();
  if (layers.length() > 2) {
    layers.remove(layers.get(2));
  }
  
  var mode = layerMode.getValue();
  var colorCode = colorTheme.getValue();
  
  // å¤„ç†éšæœºè‰²
  if (colorCode === 'random') {
    colorCode = Math.floor(Math.random()*16777215).toString(16);
  }
  
  var layerToAdd, visParams, layerName;
  
  if (mode === 'binary') {
    // æ¨¡å¼ A: äºŒå€¼å›¾
    layerToAdd = appState.binaryLayer;
    visParams = {palette: [colorCode]}; 
    layerName = 'Algae (Binary)';
  } else {
    // æ¨¡å¼ B: çƒ­åŠ›å›¾ (ä»ç™½/é»„æ¸å˜åˆ°é€‰å®šé¢œè‰²)
    layerToAdd = appState.heatmapLayer;
    visParams = {min: 0.1, max: 0.6, palette: ['white', 'yellow', colorCode]};
    layerName = 'Intensity (Heatmap)';
  }
  
  // 3. æ›´æ–°å½“å‰å›¾å±‚ (ç”¨äºä¸‹è½½)
  appState.currentLayer = layerToAdd;
  
  // 4. æ·»åŠ åˆ°åœ°å›¾
  var layer = map.addLayer(layerToAdd, visParams, layerName, true);
  layer.setOpacity(opacitySlider.getValue());
}

// =========================================
// 6. äº¤äº’åŠŸèƒ½å®ç°
// =========================================

// --- åŠŸèƒ½ A: åœ°å›¾ç‚¹å‡»ä¾¦æµ‹ ---
map.onClick(function(coords) {
  if (!appState.processedCol) return; 

  inspectorPanel.clear();
  inspectorPanel.add(ui.Label('Computing point data...', {color: 'gray'}));
  
  var point = ee.Geometry.Point([coords.lon, coords.lat]);
  
  // æ·»åŠ ç‚¹å‡»ç‚¹
  var dot = ui.Map.Layer(point, {color: 'blue'}, 'Clicked Point');
  map.layers().set(3, dot); 
  
  var pointChart = ui.Chart.image.series({
    imageCollection: appState.processedCol.select('NDVI'),
    region: point,
    reducer: ee.Reducer.mean(),
    scale: 10, 
    xProperty: 'system:time_start'
  }).setOptions({
    title: 'NDVI Trend at Point',
    vAxis: {title: 'NDVI'},
    hAxis: {title: 'Date', format: 'MM-dd'},
    colors: ['#1f618d'], 
    height: 150, 
    legend: {position: 'none'}
  });
  
  inspectorPanel.clear();
  inspectorPanel.add(ui.Label('Lon: ' + coords.lon.toFixed(4) + ', Lat: ' + coords.lat.toFixed(4), {fontSize: '10px'}));
  inspectorPanel.add(pointChart);
});

// --- åŠŸèƒ½ B: æ•°æ®ä¸‹è½½ ---
function updateDownloadButtons() {
  downloadPanel.clear();
  
  // CSV
  var statsFeature = ee.Feature(null, {
    'year': appState.currentYear,
    'total_area_km2': appState.statsArea,
    'note': 'Generated by GEE Enteromorpha App'
  });
  var statsCol = ee.FeatureCollection([statsFeature]);
  var csvUrl = statsCol.getDownloadURL({format: 'csv', filename: 'Algae_Stats_' + appState.currentYear});
  
  downloadPanel.add(ui.Label({
    value: 'ğŸ“¥ CSV Stats',
    style: {color: 'blue', border: '1px solid blue', padding: '5px', margin: '0 5px 0 0'},
    targetUrl: csvUrl
  }));
  
  // GeoTIFF
  if (appState.currentLayer) {
    var downloadArgs = {
      name: 'Algae_Map_' + appState.currentYear,
      crs: 'EPSG:4326',
      scale: 100, 
      region: study_area
    };
    var tiffUrl = appState.currentLayer.getDownloadURL(downloadArgs);
    
    downloadPanel.add(ui.Label({
      value: 'ğŸŒ GeoTIFF Map',
      style: {color: 'green', border: '1px solid green', padding: '5px'},
      targetUrl: tiffUrl
    }));
  }
}